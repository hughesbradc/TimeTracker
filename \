<?php

// This file is part of Moodle - http://moodle.org/
//
// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.

/**
 * eapendingapprove.php
 * This page will 'do magic' when a supervisor approves an error alert regarding a pending work unit.
 *
 * @package    TimeTracker
 * @copyright  Marty Gilbert & Brad Hughes
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL
 */

require_once(dirname(__FILE__) . '/../../config.php');

require_login();

$alertid = required_param('alertid', PARAM_INTEGER); // Worker id
$action = required_param('action', PARAM_ALPHA);
$alertunit = $DB->get_record('block_timetracker_alertunits', array('id'=>$alertid));
if(!$alertunit){
    //TODO Fix this to go to a pretty error page stating that the unit no longer needs action
    print_error('Alert unit no long exists');
}

$courseid = $alertunit->courseid;



$course = $DB->get_record('course', array('id' => $alertunit->courseid), '*', MUST_EXIST);
$PAGE->set_course($course);
$context = $PAGE->context;

$urlparams['id'] = $alertunit->courseid;

$nexturl = new moodle_url($CFG->wwwroot.'/blocks/timetracker/index.php', $urlparams);

$canmanage = false;
if (has_capability('block/timetracker:manageworkers', $context)) { //supervisor
    $canmanage = true;
}


//********** TODO **********//
//Add check - if request has already been approved, display 'alreadyapproved' string.
//"This work unit has already been approved by {$a} (name and time)?


if (!$canmanage && $USER->id != $worker->mdluserid){
    print_error('notpermissible','block_timetracker',
        $CFG->wwwroot.'/blocks/timetracker/index.php?id='.$COURSE->id);
} else {

    $payrate = 'SELECT payrate FROM '.$CFG->prefix.'block_timetracker_workerinfo WHERE id='.
        $alertunit->userid .';';
    $lastedited = time();
    $lasteditedby = $USER->id; //Supervisor's id
        /*
        print($alertunit->userid);
        print('<br />');
        print($alertunit->courseid);
        print('<br />');
        print($alertunit->timein);
        print('<br />');
        print($alertunit->timeout);
        print('<br />');
        print($alertunit->todelete);
        print('<br />');
        print($action);
        print('<br />');
        */
    if($action == 'approve'){
        print('You clicked approved!');
        //Add to 'workunit' table and delete from 'alertunits' and notify everyone
        $alertunit->lastedited = time();
        $alertunit->lasteditedby = $USER->id;
        $result = $DB->insert_record('block_timetracker_workunit', $alertunit);
        if(!$result){
            print_error('Something happened');       
        }
        $DB->delete_records('block_timetracker_alertunits', array('id'=>$alertunit->id));
    } else if ($action == 'deny'){
        print('You clicked deny!');
        //Delete from 'alertunits' and notify everyone
    } else {
        print('You either clicked change, or you didn\'t meet the other two conditions.');
        //What do we do here?
    }
    
    //$sql = 'INSERT INTO '.$CFG->prefix.'block_timetracker_workunit (userid, courseid, timein,
    //    timeout, payrate, lastedited, lasteditedby) ';
    //$sql .= $userid ', ', $courseid ', ', $ti ', ',$to ', ', $payrate ', ', $lastedited ', ',
    //$lasteditedby ';';
    
    //insert_record($sql);
    
    //redirect($nexturl, get_string('approvedsuccess','block_timetracker'), 2);
}
?>
